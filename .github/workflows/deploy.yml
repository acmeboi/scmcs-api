name: API Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Symfony (PHP ${{ matrix.php-versions }} on ${{ matrix.operating-system }})
    runs-on: ${{ matrix.operating-system }}

    strategy:
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['8.2']

    steps:
    # Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # Set up PHP
    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-versions }}
        coverage: none
        ini-values: opcache.enable_cli=1, opcache.jit=tracing, opcache.jit_buffer_size=64M
        extensions: mbstring, intl, pdo, pdo_mysql, zip, xml
        tools: composer, symfony-cli

    # Set environment variables
    - name: Set environment variables
      run: echo "APP_ENV=prod" >> $GITHUB_ENV

    
    # Set environment variables (.env for deploy)
    - name: Set environment variables (.env for deploy)
      env:
        APP_ENV: prod
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        # Always start fresh
        rm -f .env
        echo "APP_ENV=${APP_ENV}" >> .env
        echo "DATABASE_URL=${DATABASE_URL}" >> .env

    # Install dependencies
    - name: Install dependencies
      run: composer install --no-dev --optimize-autoloader --no-scripts

    # Generate JWT keys
    - name: Generate JWT keys
      run: |
        mkdir -p config/jwt
        openssl genpkey -out config/jwt/private.pem -algorithm RSA -pkeyopt rsa_keygen_bits:2048
        openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem
        chmod 600 config/jwt/*.pem

    # Configure JWT keys
    - name: Configure JWT keys
      run: echo "JWT keys generated. Skipping cache:clear in CI to avoid DB errors."
    
    # Clear cache (will be done on server after deployment)
    - name: Note about cache clearing
      run: echo "Cache will be cleared on production server after deployment"

    # Build the API Platform Metadata (Optional but recommended)
    - name: Build API Platform cache
      run: php bin/console assets:install public || echo "Skip if DB not available"

    # Deploy to FTPS
    - name: Deploy to FTPS
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /
        include: '**/*'
        exclude: |
          .env
          **/cache/prod/** 
          .git/** 
          .github/** 
          tests/**

    # Post-deployment cleanup (skip DB in CI)
    - name: Post-deployment cleanup
      run: echo "Skip DB in CI. Warmup will run on server."

